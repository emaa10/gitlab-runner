name: Host GitLab Runner

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

concurrency:
  group: gitlab-runner
  cancel-in-progress: true

jobs:
  host-runner:
    runs-on: ubuntu-latest

    steps:
    - name: Setup Docker container
      run: |
        # Cleanup previous containers
        docker rm -f gitlab-runner || true
        docker volume create runner-config || true

        # Start base container in detached mode
        docker run -d --name gitlab-runner \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v runner-config:/etc/gitlab-runner \
          gitlab/gitlab-runner:latest \
          sleep infinity

    - name: Register Runner
      run: |
        # Execute registration command
        docker exec gitlab-runner sh -c "\
          gitlab-runner register \
          --non-interactive \
          --url 'https://gitlab.com' \
          --registration-token ${{ secrets.GITLAB_RUNNER_TOKEN }} \
          --executor docker \
          --docker-image docker:latest \
          --description 'GitHub-Hosted Runner' \
          --tag-list github-actions \
          --run-untagged \
          --locked=false"

    - name: Start Runner Service
      run: |
        # Start the runner in foreground
        docker exec -d gitlab-runner gitlab-runner run
        # Keep container alive for 2 hours
        sleep 7200
