name: Host GitLab Runner

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

concurrency:
  group: gitlab-runner
  cancel-in-progress: true

jobs:
  host-runner:
    runs-on: ubuntu-latest

    steps:
    - name: Start GitLab Runner
      run: |
        # Alten Container entfernen
        docker rm -f gitlab-runner || true

        # Neuen Container im Vordergrund mit persistentem Config-Volume starten
        docker run --name gitlab-runner \
          -e GITLAB_CI_URL="https://gitlab.com" \
          -e REGISTRATION_TOKEN=${{ secrets.GITLAB_RUNNER_TOKEN }} \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v gitlab-runner-config:/etc/gitlab-runner \
          gitlab/gitlab-runner:latest \
          /bin/sh -c "
            gitlab-runner register --non-interactive \
              --url \$GITLAB_CI_URL \
              --registration-token \$REGISTRATION_TOKEN \
              --executor docker \
              --docker-image docker:latest \
              --description 'GitHub-Hosted Runner' \
              --tag-list github-actions \
              --run-untagged \
              --locked=false
              
            gitlab-runner run --user=gitlab-runner --working-directory=/home/gitlab-runner
          "
