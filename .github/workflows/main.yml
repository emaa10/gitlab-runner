name: Host GitLab Runner

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

concurrency:
  group: gitlab-runner
  cancel-in-progress: true

jobs:
  host-runner:
    runs-on: ubuntu-latest

    steps:
    - name: Start GitLab Runner
      run: |
        # Alten Container und Volume entfernen
        docker rm -f gitlab-runner || true
        docker volume rm gitlab-runner-config || true

        # Neues Volume erstellen
        docker volume create gitlab-runner-config

        # Registrierung in temp. Container
        docker run --rm \
          -v gitlab-runner-config:/etc/gitlab-runner \
          -e GITLAB_CI_URL="https://gitlab.com" \
          -e REGISTRATION_TOKEN=${{ secrets.GITLAB_RUNNER_TOKEN }} \
          gitlab/gitlab-runner:latest \
          gitlab-runner register \
          --non-interactive \
          --url "$GITLAB_CI_URL" \
          --registration-token "$REGISTRATION_TOKEN" \
          --executor docker \
          --docker-image docker:latest \
          --description "GitHub-Hosted Runner" \
          --tag-list github-actions \
          --run-untagged \
          --locked=false

        # Haupt-Container starten
        docker run -d --name gitlab-runner \
          -v gitlab-runner-config:/etc/gitlab-runner \
          -v /var/run/docker.sock:/var/run/docker.sock \
          gitlab/gitlab-runner:latest \
          gitlab-runner run

        # Wartezeit für 2h bis zum nächsten Lauf
        sleep 7200
