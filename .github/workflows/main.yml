name: Host GitLab Runner

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

concurrency:
  group: gitlab-runner
  cancel-in-progress: true

jobs:
  host-runner:
    runs-on: ubuntu-latest

    steps:
    - name: Start base container
      run: |
        docker rm -f gitlab-runner || true
        docker volume create runner-config || true
        docker run -d --name gitlab-runner \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v runner-config:/etc/gitlab-runner \
          gitlab/gitlab-runner:latest \
          sleep infinity

    - name: Verify container health
      run: |
        docker ps --filter "name=gitlab-runner" --format "{{.Status}}"
        docker exec gitlab-runner echo "Container is ready"

    - name: Register runner
      run: |
        docker exec gitlab-runner sh -c "\
          /usr/bin/gitlab-runner register \
          --non-interactive \
          --url 'https://gitlab.com' \
          --registration-token ${{ secrets.GITLAB_RUNNER_TOKEN }} \
          --executor docker \
          --docker-image docker:latest \
          --description 'GitHub-Hosted Runner' \
          --tag-list github-actions \
          --run-untagged \
          --locked=false"

    - name: Start runner service
      run: |
        docker exec -d gitlab-runner /usr/bin/gitlab-runner run
        sleep 7200
